#!/usr/bin/env bash
#
# Chatbot Configuration Editor
#
# This script launches the Django-based chatbot configuration manager.
# It uses 'uv' to automatically manage dependencies without requiring manual installation.
#
# Requirements:
#   - uv installed (https://github.com/astral-sh/uv)
#   - This script should be run from the repository directory
#
# Usage:
#   ./cbc-edit
#

set -e

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Change to the script directory
cd "$SCRIPT_DIR"

echo "=========================================="
echo "  Chatbot Configuration Editor"
echo "=========================================="
echo ""

# Check if uv is installed
if ! command -v uv &> /dev/null; then
    echo "Error: 'uv' is not installed."
    echo "Please install uv: https://github.com/astral-sh/uv"
    echo ""
    echo "Quick install:"
    echo "  curl -LsSf https://astral.sh/uv/install.sh | sh"
    exit 1
fi

echo "Initializing application..."
echo ""

# Run database migrations
echo "Setting up database..."
uv run python manage.py migrate --no-input

# Check if a superuser exists, if not create one
echo ""
echo "Checking for admin user..."
uv run python manage.py shell -c "
from django.contrib.auth import get_user_model;
User = get_user_model();
if not User.objects.filter(is_superuser=True).exists():
    User.objects.create_superuser('admin', 'admin@example.com', 'admin');
    print('Created admin user: admin/admin');
else:
    print('Admin user already exists');
" 2>/dev/null || true

echo ""
echo "=========================================="
echo "  Starting Development Server"
echo "=========================================="
echo ""
echo "Admin interface will be available at:"
echo "  http://127.0.0.1:8000/admin/"
echo ""
echo "Login credentials:"
echo "  Username: admin"
echo "  Password: admin"
echo ""
echo "Configuration files will be stored in:"
echo "  $(pwd)"
echo ""
echo "Press Ctrl+C to stop the server"
echo ""

# Start the Django development server
uv run python manage.py runserver
