#!/usr/bin/env -S uv run
# /// script
# requires-python = ">=3.11"
# dependencies = [
#     "cb-config",
#     "django>=5.0,<6.0",
#     "django-grappelli>=4.0,<5.0",
#     "pydantic>=2.0,<3.0",
# ]
#
# [tool.uv.sources]
# cb-config = { git = "https://github.com/kheast/cb-config.git" }
# ///
"""
Chatbot Configuration Editor

A standalone script for managing chatbot configurations.
Downloads the application directly from GitHub and runs it locally.

Requirements:
  - uv installed (https://github.com/astral-sh/uv)

Usage:
  ./cbc-edit
"""

import os
import sys
import subprocess
from pathlib import Path


def main():
    """Launch the Django development server for chatbot configuration management."""

    print("=" * 50)
    print("  Chatbot Configuration Editor")
    print("=" * 50)
    print()

    # Set up Django settings
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'cbconfig.settings')

    # Import Django
    try:
        import django
        from django.core.management import execute_from_command_line
    except ImportError as e:
        print(f"Error: Failed to import Django: {e}")
        print()
        print("This should not happen. Please ensure uv is installed correctly.")
        sys.exit(1)

    # Setup Django
    django.setup()

    print("Initializing application...")
    print()

    # Run migrations
    print("Setting up database...")
    execute_from_command_line(['cbc-edit', 'migrate', '--no-input'])

    # Check if a superuser exists, if not create one
    print()
    print("Checking for admin user...")

    from django.contrib.auth import get_user_model
    User = get_user_model()

    if not User.objects.filter(is_superuser=True).exists():
        User.objects.create_superuser('admin', 'admin@example.com', 'admin')
        print("Created admin user: admin/admin")
    else:
        print("Admin user already exists")

    print()
    print("=" * 50)
    print("  Starting Development Server")
    print("=" * 50)
    print()
    print("Admin interface will be available at:")
    print("  http://127.0.0.1:8000/admin/")
    print()
    print("Login credentials:")
    print("  Username: admin")
    print("  Password: admin")
    print()
    print("Configuration files will be stored in:")
    print(f"  {Path.cwd()}")
    print()
    print("Press Ctrl+C to stop the server")
    print()

    # Start the Django development server
    execute_from_command_line(['cbc-edit', 'runserver'])


if __name__ == '__main__':
    main()
